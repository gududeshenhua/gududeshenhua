<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" type="text/css" href="../vendors/jquery-easyui-1.4.5/themes/bootstrap/easyui.css"/>
    <link rel="stylesheet" type="text/css" href="../vendors/jquery-easyui-1.4.5/themes/icon.css"/>

    <script type="text/javascript" src="../vendors/jquery1.11.3/jquery.min.js"></script>     
    <script type="text/javascript" src="../vendors/jquery-easyui-1.4.5/jquery.easyui.min.js"></script>   
    <script type="text/javascript" src="../vendors/jquery-easyui-1.4.5/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../js/datagrid-detailview.js"></script>
    <script type="text/javascript" src="../js/jquery.startsi.js"></script>
    <script type='text/javascript' src="../js/JSON.js"></script>
    
    
	<style type="text/css">
		* {
				font-size: 15px;
			}
			
			.textbox-text {
				width: 100px;
			}
			
			.mymask {
				z-index: 99999999;
			}
			input,select{
				border-radius: 3px;
			}
	</style>
</head>
<body>
		
			<div class="easyui-panel" title="查询条件" style="width:100%;">
        		<div style="padding:10px 10px 20px 10px">
        		<form id="curd_queryform1" class="easyui-form1" method="post" data-options="novalidate:true">
            	<table cellpadding="5">
                <tr>
                  <!--<td>使用单位:</td>
                  <td><select  name="areacode" id="areacode" style="width:130px;height: 25px;"></select></td>-->
                  <td>证件类型:</td>
                  <td><select  name="passtype" id="selectPage" style="width:150px;height: 25px;"></select></td>
                  <td>证件号码:</td>  
                  <td><input  type="text" name="passno" id="passno"  style="width:150px;height: 20px;" maxlength="9" style="border-radius:3px;border:1px solid #ddd!important;"></input></td>  
                  <td>业务条码:</td>  
                  <td><input  type="text" name="barcode" id="barcode" style="width:160px;height: 20px;" maxlength="15" style="border-radius:3px;border:1px solid #ddd!important;"></input></td>    
				  <td>
				  <a style="width: 118px;" class="easyui-linkbutton c1 l-btn l-btn-small query" href="javascript:void(0)" group="" id="" onclick="query2('fw-cabinet.cabinetService.queryBoxOperlogtbl');">
                	<span class="l-btn-left" style="margin-top: 0px;"><span class="l-btn-text">查询</span></span>
           		 </a>
           		 <a style="width: 118px;" class="easyui-linkbutton c5 l-btn l-btn-small cancel" href="javascript:void(0)" group="" id="">
                	<span class="l-btn-left" style="margin-top: 0px;"><span class="l-btn-text">清除</span></span>
           		 </a>	
				  </td>
                </tr>
				
            	</table>
       			</form>
       			
        		<!--<div style="text-align:left;padding:5px">
           		 <a style="width: 118px;" class="easyui-linkbutton c1 l-btn l-btn-small query" href="javascript:void(0)" group="" id="" onclick="query2('fw-cabinet.cabinetService.queryBoxOperlogtbl');">
                	<span class="l-btn-left" style="margin-top: 0px;"><span class="l-btn-text">查询</span></span>
           		 </a>
           		 <a style="width: 118px;" class="easyui-linkbutton c5 l-btn l-btn-small cancel" href="javascript:void(0)" group="" id="">
                	<span class="l-btn-left" style="margin-top: 0px;"><span class="l-btn-text">清除</span></span>
           		 </a>	
       			 </div>-->
      			</div>
   		 </div>
   		 <div style="margin:20px 0;"></div>
   		 	<!--<div class="easyui-panel" style="width:100%;height: 500px;" id="curd_layout_center">
        		<table id="curd_datagrid1" class="easyui-datagrid1" title="证件流水信息列表" style="width:100%;height:400px;border:true"></table>
   			</div>-->
			<div class="easyui-panel" style="width:100%;" id="curd_layout_center">
        		<table id="curd_datagrid1" class="easyui-datagrid"  style="width:100%;border:true"></table>
    		</div>
		
		
	
   
    <div id="curd_toolbar1" style="text-align:left; padding:2px 10px 2px 0px;height:auto">
        <!--<a href="#" id="curd_btnadd"    class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true">添加</a>
        <a href="#" id="curd_btnadd"    class="easyui-linkbutton" data-options="iconCls:'icon-search',plain:true">选证组包</a>
        <a href="#" id="curd_btnexcel"  class="easyui-linkbutton" data-options="iconCls:'icon-undo',plain:true" onclick="getPackDown();">选包下架</a>-->
        <a href="#" id="execlexport"  class="easyui-linkbutton" data-options="iconCls:'icon-redo',plain:true">导出EXCEL</a>
    </div> 
        
    <script type="text/javascript"> 
    jQuery.support.cors=true;
    //页面初始化
    var alljsondata="";
	var sessionid="";
	var areacode="";
    $(function() {      
     	sessionid = JSON.parse(sessionStorage['sessionid']);
		areacode = JSON.parse(sessionStorage['userinf']).areacode;
		////console.log("输出areacode");
		////console.log(areacode);
     	initcomgrid('','selectPage','903','');
     	//setTimeout("initcomgrid('','areacode','699','11%')",1000);
        
       
       
        $('#curd_datagrid1').startsi_datagrid({ 
            toolbar: '#curd_toolbar1',
			fit:false,
			fitColumns:true,
			 remoteSort:false,
            idField : 'boxid',  //ID字段名，必须的，用于定位行的位置
            columns : [[        //显示表列
                
                {field:'barcode',title:'业务条形码',width:100,sortable:true},
                //{field:'surname',title:'中文姓',width:100},
                //{field:'givename',title:'中文名',width:100},
                //{field:'esurname',title:'英文姓',width:100},
                //{field:'egivename',title:'英文名',width:100},
                {field:'cpasstype',title:'证件类型',width:100,sortable:true},
                {field:'passno',title:'证件号码',width:100,sortable:true},
				{field:'cabinetid',title:'柜编号',width:100,sortable:true},
                {field:'boxid',title:'格子编号',width:100,sortable:true},
                {field:'actdate',title:'处理时间',width:100,sortable:true},
				{field:'actionflag',title:'处理标志',width:100,sortable:true}
               // {field:'ywbh',title:'是否已经发证',width:100},
                //{field:'ywbh',title:'下架组包号',width:100},
                //{field:'ywbh',title:'<span class="tablecolhead">组包序号</sapn>',width:100}
            ]],onLoadSuccess:function(data){
            	initpaination();
            },onDblClickRow:function(rowIndex,rowData){
                      /*  rowOfData = rowData;
                        $.messager.show({msg:'查询审核信息成功!',title:'提示'});
                        $('#win').window('open');*/
            }/*,onSelect:function(rowIndex,rowData){
            	//console.log(rowData);
            }*/
       });
	   
	   $("#curd_datagrid1").datagrid('resize',{   
					height:($(window).height()*0.7) 
				});
      
    });
	
	
	
	
	
	
	
	function initpaination(){
		var p = $('#curd_datagrid1').datagrid('getPager');  
		$(p).pagination({  
    		onSelectPage: function(pageNumber, pageSize){
    		  ////console.log("在分页方法里触发");
			  ////console.log(alljsondata);
			  var dataA = pagerFilter(alljsondata, pageNumber, pageSize, 'curd_datagrid1');
			  $('#curd_datagrid1').startsi_datagrid('loadData', dataA);
    		}
		});   
	}
	
	
    //js去除数组中重复字符的方法;
    function unique(array){
        var n = [array[0]]; //结果数组
        //从第二项开始遍历
        for(var i = 1; i < array.length; i++) {
            //如果当前数组的第i项在当前数组中第一次出现的位置不是i，
            //那么表示第i项是重复的，忽略掉。否则存入结果数组
            if (array.indexOf(array[i]) == i) n.push(array[i]);
        }
        return n;
    }
    
    
    //证件流水信息查询方法
    function query2(funcid){
    	
    	//var passtypevalue = $("input[name='passtype']").val();
    	
    	var boxoperlogtbl = $('#curd_queryform1').startsi_serializeform();
		if(areacode="110000"){
    	boxoperlogtbl.areacode="";
		}else{
		boxoperlogtbl.areacode=areacode;
		}
		
    	//var selectvalue = $('#selectPage').startsi_combogrid('getValue');
    	if((boxoperlogtbl.passtype!="" && boxoperlogtbl.passno!="")||(boxoperlogtbl.barcode!="")){
    		
    	
    	
    	//var data={'boxoperlogtbl':boxoperlogtbl}
    	var data={'boxoperlogtbl':boxoperlogtbl}
		var jsondata={
			'token':sessionid,
			'funcid':funcid,
			'data':data
			}
	    
		var param =JSON.stringify(jsondata);
		////console.log("输出查询流水信息要传的数据");
		////console.log(param);
  		//  var postUrl = '/FWWeb/index.do';  //"/FWWeb/index.do";
    	//var postUrl = '/FWWeb/index.do?easyui_query='+JSON.stringify(jsondata)+'';
		MaskUtil.mask();
			$.ajax({
				url:'/FWWeb/index.do',
				method:'post',
				async:true,
				data:param,
				dataType:'json',
				success:function(result){
				MaskUtil.unmask();
					//$(".datagrid-btable tbody").remove();
					////console.log("query2返回结果");
					////console.log(result);
					var jsonObj="";
					if('object' == typeof result){
                   		 jsonObj = result;
                	}else{
                   		 jsonObj = $.parseJSON(result);
               		}
					////console.log(jsonObj);
					if($.isEmptyObject(jsonObj.data)){
                    $.messager.show({msg:'没有查到相应的数据!',title:'提示'});
                    $('#curd_datagrid1').datagrid('loadData', { total: 0, rows: []}); 
                    	return;
                	}else{
                    	$.messager.show({msg:'查询成功!',title:'提示'});
                	}
                    var obj=[]
                		$.each(jsonObj.data.boxoperlogtbl,function(i,d){
						if(d.actionflag=="1"){
							d.actionflag ="上架完成"; 
						}
						if(d.actionflag=="2"){
							d.actionflag ="发证完成"; 
						}
						if(d.actionflag=="3"){
							d.actionflag ="下架完成"; 
						}
                    	obj.push(d);
                	})
                	alljsondata=obj;
                	var newdata = pagerFilter(obj, 1, 10, 'curd_datagrid1');
					 $('#curd_datagrid1').startsi_datagrid('loadData',newdata);
					},
					complete:function(){
						//alert();
					},error:function(XMLHttpRequest, textStatus, errorThrown){

               					 $.messager.alert({msg:'请求超时，请检查网络!',title:'提示'});
								MaskUtil.unmask();
            		}
		});
		
		}else{
			$.messager.alert({msg:'请选择证件种类+证件号码或业务条码组合查询!',title:'提示'});
    		return;
		}
    }
    
    
    
    //添加按钮
   
    
    
    
    
    
    //清空按钮
    function resets(){
        $('#curd_queryform1').form('clear');
    }; 
    
    

    
    
    
    function initcomgrid(param,id,kindvalue,code) {
    	var comboid ='#'+id;
    	var dataA="";
    	if(param ==""){
    		var sql ="select * from xt_zdb_view where kind ='"+kindvalue+"'";
    		if(code!=""){sql = sql +" and code like '"+code+"'";}
		var data = {'sql': sql,'rowtype': 'lpreapplytbl'};
		var jsondata = {'token': sessionid,'funcid': 'fw-preapply.chineseService.querySql','data': data};
			 dataA = JSON.stringify(jsondata);
			 ////console.log(dataA)
		}else{
			dataA =param;
			
		}
				$.ajax({
					url: '/FWWeb/index.do',
					method: 'post',
					async: true,
					data: dataA,
					dataType: 'json',
					success: function(result) {
						////console.log(result)
						var jsonObj;
						if('object' == typeof result) {
							jsonObj = result;
						} else {
							jsonObj = $.parseJSON(result);
						}
						////console.log(jsonObj.rows);
						var obj = []
						$.each(jsonObj.rows, function(i, d) {
							obj.push(d);
						})
						var data = pagerFilter(jsonObj.rows, 1, 10, 'selectPage');
						
						$(comboid).startsi_combogrid({
							panelWidth: 500,
							data: data,
							idField: 'code', //ID字段 
							textField: 'note', //显示的字段 
							fitColumns: true,
							striped: true,
							editable: true,
							pagination: true, //是否分页 
							rownumbers: true, //序号 
							collapsible: false, //是否可折叠的 
							//fit: true, //自动大小  影响大小的罪魁祸首
							pageSize: 10, //每页显示的记录条数，默认为10 
							pageList: [10], //可以设置每页记录条数的列表 
							//method: 'post',
							columns: [
								[{
									field: 'code',
									title: '代码',
									width: 40
								}, {
									field: 'note',
									title: '中文',
									width: 120
								}, {
									field: 'pycode',
									title: '拼音代码',
									width: 70
								}]
							],
							keyHandler: {
								/*up: function() {}, 
								down: function() {}, 
								enter: function() {},*/
								query: function(q) {
									//var sql = "select * from xt_zdb_view where kind ='"+kindvalue+"' and code like '"+code+"' and code like '%" + q + "%'";
									var sql ="select * from xt_zdb_view where kind ='"+kindvalue+"' and code like '%" + q + "%'";
    								if(code!=""){sql = sql +" and code like '"+code+"'";}
									//动态搜索 
									//$('#selectPage').combogrid("grid").datagrid("load", { 'keyword': q });
									//$('#selectPage').combogrid("setValue", q);
									var data = {
										'sql': sql,
										'rowtype': 'lpreapplytbl'
									};
									//var data={"table_name":"WW_CHECKRESULTTBL","rowtype":[{"id":"CS201208172102","returnflag":"0","recheckflag":"2"}]};
									var jsondata = {
										'token': sessionid,
										'funcid': 'fw-preapply.chineseService.querySql',
										'data': data
									}
									var dataA = JSON.stringify(jsondata);
									//initcomgrid(dataA,id,kindvalue,code);
									$.ajax({
										url: '/FWWeb/index.do',
										method: 'post',
										async: true,
										data: dataA,
										dataType: 'json',
										success:function(data){
											jsonObj = data;
											////console.log(jsonObj);
											var dataB = pagerFilter(jsonObj.rows, 1, 10, 'selectPage');
											var pg = $(comboid).startsi_combogrid('grid');
											pg.datagrid('loadData', dataB);
											
											
											////console.log(selectvalue);
											$(comboid).startsi_combogrid('setValue',q);
										}
									});
								}
							},
							onLoadSuccess: function(data) {
								////console.log("success");

								var pg = $(comboid).startsi_combogrid('grid');
								var page = pg.datagrid('getPager');
								$(page).pagination({
									onSelectPage: function(pageNumber, pageSize) {

										////console.log("在分页方法里触发");
										var data = pagerFilter(jsonObj.rows, pageNumber, pageSize, id);
										////console.log(allparam)
										////console.log(allparam.data);
										//inittabledata(allparam);
										pg.datagrid('loadData', data);
										//$.messager.show({msg:'查询成功!',title:'提示'});
									}
								});

							}

						});
						//$(".combo").css({'width':'100px'});
					}
				});

			}
    
    function pagerFilter(data, pageNumber, pageSize, id) {
				////console.log("进入pagerFilter方法");
				////console.log("过滤前的数据");
				////console.log(data);
				if(typeof data.length == 'number' && typeof data.splice == 'function') { // 判断数据是否是数组
					data = {
						total: data.length,
						rows: data
					}
				}
				var dg = $('#' + id);
				
				////console.log(pageNumber);
				////console.log(pageSize);
				var start = (pageNumber - 1) * parseInt(pageSize);
				var end = start + parseInt(pageSize);
				//多少条到多少条
				data.rows = (data.rows.slice(start, end));
				////console.log("输出顾虑后的数据");
				////console.log(data);
				return data;
			}
    
    //easyui加载等待提示框方法  方法开始    
			var MaskUtil = (function() {
				var $mask, $maskMsg;
				var defMsg = '正在处理，请稍待。。。';

				function init() {
					if(!$mask) {
						$mask = $("<div class=\"datagrid-mask mymask\"></div>").appendTo("body");
					}
					if(!$maskMsg) {
						$maskMsg = $("<div class=\"datagrid-mask-msg mymask\">" + defMsg + "</div>")
							.appendTo("body").css({
								'font-size': '12px'
							});
					}
					$mask.css({
						width: "100%",
						height: $(document).height()
					});
					var scrollTop = $(document.body).scrollTop();
					$maskMsg.css({
						left: ($(document.body).outerWidth(true) - 190) / 2,
						top: (($(window).height() - 45) / 2) + scrollTop
					});
				}
				return {
					mask: function(msg) {
						init();
						$mask.show();
						$maskMsg.html(msg || defMsg).show();
					},
					unmask: function() {
						$mask.hide();
						$maskMsg.hide();
					}
				}
			}());
			//方法结束
			
			
			
			
			function replaceHtml(replacedStr, repStr, endStr) {
    var replacedStrF = "";
    var replacedStrB = "";
    var repStrIndex = replacedStr.indexOf(repStr);
    while (repStrIndex != -1) {
        replacedStrF = replacedStr.substring(0, repStrIndex);
        replacedStrB = replacedStr.substring(repStrIndex, replacedStr.length);
        replacedStrB = replacedStrB.substring(replacedStrB.indexOf(endStr) + 1, replacedStrB.length);
        replacedStr = replacedStrF + replacedStrB;
        repStrIndex = replacedStr.indexOf(repStr);
    }
    return replacedStr;
}  
  
  
  
var ToExcel_FF = (function() {
    var uri = 'data:application/vnd.ms-excel;base64,',
      template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>',
        base64 = function(s) { return window.btoa(unescape(encodeURIComponent(s))) },
        format = function(s, c) {
            return s.replace(/{(\w+)}/g,
            function(m, p) { return c[p]; })
        }
    return function(GridPanel_ID, Border) {
       // var elDiv = document.getElementById(GridPanel_ID);
       var elDiv = $('.datagrid-btable');
       var columns = $("#curd_datagrid1").datagrid("options").columns[0]; 
       ////console.log("输出表头的信息");
       ////console.log(columns)
       var str ='<tr id="addid">';
       $.each(columns, function(i,d) {
       		str+='<td>'+d.title+'</td>'
       });
       str+='</tr>';
       ////console.log("拼接后的表头信息");
       ////console.log(str);
      $('.datagrid-btable').prepend(str);
       ////console.log("输出eDIv html");
      ////console.log(elDiv.html);
      //return;
        //过滤elDiv内容
        var elDivStr = elDiv.html();
        //var elDivStr = elDiv.innerHTML;
        elDivStr = replaceHtml(elDivStr, "<a", ">");
        elDivStr = replaceHtml(elDivStr, "</a", ">");
        elDivStr = replaceHtml(elDivStr, "<img", ">");
        //设置table的border=1，这样到excel中就有表格线 ps:感谢双面提醒
        if (Border != null) {
            elDivStr = elDivStr.replace(/<table/g, "<table border=" + Border);
        }
        var ctx = { worksheet: '' || 'Worksheet', table: elDivStr }
        window.location.href = uri + base64(format(template, ctx));
        //返回格式变换以前的内容
        elDivStr = "";
        elDiv = null;
    }
})()
   
   //判断浏览器的类型
    function  getExplorer() {    
            var explorer = window.navigator.userAgent ;    
            //ie    
            if (explorer.indexOf("MSIE") >= 0) {    
                return 'ie';    
            }    
            //firefox    
            else if (explorer.indexOf("Firefox") >= 0) {    
                return 'Firefox';    
            }    
            //Chrome    
            else if(explorer.indexOf("Chrome") >= 0){    
                return 'Chrome';    
            }    
            //Opera    
            else if(explorer.indexOf("Opera") >= 0){    
                return 'Opera';    
            }    
            //Safari    
            else if(explorer.indexOf("Safari") >= 0){    
                return 'Safari';    
            }    
        }    
   
   
    //toolbar几点点击事件的绑定
    //一键导出EXECL的时间绑定
    $("#execlexport").click(function(){
    	//alert();
    	////console.log($('div.export ul.dropdown-menu li').eq(5).html())
    	$('#lookall').trigger('click');
    	//$('div.export ul.dropdown-menu li').eq(5).trigger('click');
    	//setTimeout("$('#lookbuk').trigger('click');$('div.export ul.dropdown-menu li').eq(5).trigger('click');",300);
    	
    	  if(getExplorer()=='ie') {   
            //获取Datagride的列  
            	var rows = $('#curd_datagrid1').datagrid('getRows');  
            	var columns = $("#curd_datagrid1").datagrid("options").columns[0];  
            	////console.log("输出列");
            	////console.log(columns);
            	//var a= columns.splice(1,1);//用来移除指定的数组元素
            	////console.log("输出移除列以后的东西");
            	////console.log(a);
            	var oXL = new ActiveXObject("Excel.Application"); //创建AX对象excel   
            	var oWB = oXL.Workbooks.Add(); //获取workbook对象   
            	var oSheet = oWB.ActiveSheet; //激活当前sheet  
            	//设置工作薄名称  
            	oSheet.name = "导出Excel报表";  
            	//设置表头  
            	for (var i = 0; i < columns.length; i++) {  
               	 oSheet.Cells(1, i+1).value = columns[i].title;  
            	}  
            	//设置内容部分  
            	for (var i = 0; i < rows.length; i++) {  
                //动态获取每一行每一列的数据值  
                for (var j = 0; j < columns.length; j++) {                 
                    oSheet.Cells(i + 2, j+1).value = rows[i][columns[j].field];  
                	}     
            	}                
            	oXL.Visible = true; //设置excel可见属性  
            	//var a  = "C:"+"\\"+""\+"d.xls"
            	//oXL.saveAs();
			}else{
				ToExcel_FF('curd_datagrid1',1);
				$("#addid").hide();
			}
    })
			
			
			
	
</script>
</body>
</html>